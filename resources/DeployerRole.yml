Type: AWS::IAM::Role
Properties:
 AssumeRolePolicyDocument:
    Statement:
    - Effect: Allow
      Action: sts:AssumeRole
      Principal:
        Service: lambda.amazonaws.com
    Version: '2012-10-17'
  Policies:
    - PolicyName: APIGatewayCRUDAccess
      PolicyDocument: 
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action:
              - "apigateway:GET"
              - "apigateway:PATCH"
              - "apigateway:POST"
              - "apigateway:PUT"
            Resource:
              - !Sub "arn:aws:apigateway:${aws:region}::/apis"
    - PolicyName: CloudFormationStackFullAccess
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "cloudformation:CancelUpdateStack"
              - "cloudformation:ContinueUpdateRollback"
              - "cloudformation:CreateChangeSet"
              - "cloudformation:CreateStack"
              - "cloudformation:CreateUploadBucket"
              - "cloudformation:DeleteStack"
              - "cloudformation:Describe*"
              - "cloudformation:EstimateTemplateCost"
              - "cloudformation:ExecuteChangeSet"
              - "cloudformation:Get*"
              - "cloudformation:List*"
              - "cloudformation:UpdateStack"
              - "cloudformation:UpdateTerminationProtection"
            Resource: !Sub "arn:aws:cloudformation:${aws:region}:${env:AWS_ACCOUNT_ID}:stack/${self:service}*/*"
    - PolicyName: CloudFormationTemplateValidation
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "cloudformation:ValidateTemplate"
            Resource: "*"
    - PolicyName: CloudFormationValidateAllTemplates
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "ec2:Describe*"
            Resource:
              - "*"
    - PolicyName: EventBridgeEvents
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: Allow
          Action:
            - "events:Put*"
            - "events:Describe*"
            - "events:List*"
          Resource: !Sub "arn:aws:events:${aws:region}:${env:AWS_ACCOUNT_ID}:rule/${self:service}*"
    - PolicyName: IAMRoleManipulation
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "iam:AttachRolePolicy"
              - "iam:CreateRole"
              - "iam:DeleteRole"
              - "iam:DeleteRolePolicy"
              - "iam:DetachRolePolicy"
              - "iam:GetRole"
              - "iam:PassRole"
              - "iam:PutRolePolicy"
            Resource:
              - !Sub "arn:aws:iam::*:role/${self:service}*-lambdaRole"
    - PolicyName: LambdaFullAccess
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "lambda:*"
            Resource:
              - !Sub "arn:aws:lambda:*:*:function:${self:service}*"
    - PolicyName: CloudWatchLogGroupReadAccess
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "logs:DescribeLogGroups"
            Resource: !Sub "arn:aws:logs:${aws:region}:${env:AWS_ACCOUNT_ID}:log-group::log-stream:*"
    - PolicyName: CloudWatchServiceLogGroupAccess
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: Allow
          Action:
            - "logs:CreateLogGroup"
            - "logs:CreateLogStream"
            - "logs:DescribeLogStreams"
            - "logs:FilterLogEvents"
          Resource: !Sub arn:aws:logs:${aws:region}:${env:AWS_ACCOUNT_ID}:log-group:/aws/lambda/${self:service}*:log-stream:*
    - PolicyName: S3DeploymentBucketAccess
      PolicyDocument:
        Version: "2012-10-17"
        Statement:  
          - Effect: Allow
            Action:
              - "s3:CreateBucket"
              - "s3:DeleteBucket"
              - "s3:DeleteBucketPolicy"
              - "s3:DeleteObject"
              - "s3:DeleteObjectVersion"
              - "s3:Get*"
              - "s3:List*"
              - "s3:PutBucketNotification"
              - "s3:PutBucketPolicy"
              - "s3:PutBucketTagging"
              - "s3:PutBucketWebsite"
              - "s3:PutEncryptionConfiguration"
              - "s3:PutObject"
            Resource:
              - !Sub "arn:aws:s3:::${self:service}*"
      - PolicyName: S3FullAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:  
              - Effect: Allow
                Action:
                  - "s3:*"
                Resource:
                  - !Sub "arn:aws:s3:::${self:service}*/*"
